{% extends "base.html" %}

{% block title %}Analysis - {{ log_file.original_filename }} - Sentinel Logger{% endblock %}

{% block extra_css %}
<style>
/* Issue Card Styles */
.issue-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 5px solid #dee2e6;
}

.issue-card.critical { border-left-color: #6f42c1; }
.issue-card.high { border-left-color: #dc3545; }
.issue-card.medium { border-left-color: #ffc107; }
.issue-card.low { border-left-color: #28a745; }

.issue-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.issue-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1a1a2e;
    margin-bottom: 0.25rem;
}

.issue-description {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.severity-badge {
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.severity-badge.critical { background: #6f42c1; color: white; }
.severity-badge.high { background: #dc3545; color: white; }
.severity-badge.medium { background: #ffc107; color: #212529; }
.severity-badge.low { background: #28a745; color: white; }

/* Explanation Boxes */
.explanation-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.explanation-section h6 {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #6c757d;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.explanation-section p {
    margin: 0;
    color: #495057;
    font-size: 0.9rem;
    line-height: 1.5;
}

.impact-section {
    background: #fff3cd;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.impact-section h6 {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #856404;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.impact-section p {
    margin: 0;
    color: #856404;
    font-size: 0.9rem;
}

/* Suggested Actions */
.actions-list {
    list-style: none;
    padding: 0;
    margin: 0 0 1rem 0;
}

.actions-list li {
    padding: 0.5rem 0;
    padding-left: 1.5rem;
    position: relative;
    color: #495057;
    font-size: 0.9rem;
    border-bottom: 1px solid #f1f1f1;
}

.actions-list li:last-child {
    border-bottom: none;
}

.actions-list li::before {
    content: "â†’";
    position: absolute;
    left: 0;
    color: #0d6efd;
    font-weight: bold;
}

/* Log Evidence Box */
.log-evidence {
    background: #1e1e1e;
    border-radius: 8px;
    overflow: hidden;
    margin-top: 1rem;
}

.log-evidence-header {
    background: #2d2d2d;
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.log-evidence-header h6 {
    color: #e0e0e0;
    margin: 0;
    font-size: 0.8rem;
    font-weight: 500;
}

.log-evidence-content {
    padding: 0;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
    font-size: 0.8rem;
}

.log-line {
    padding: 0.4rem 1rem;
    border-bottom: 1px solid #2d2d2d;
    display: flex;
    gap: 1rem;
}

.log-line:last-child {
    border-bottom: none;
}

.log-line.issue-line {
    background: rgba(220, 53, 69, 0.15);
    border-left: 3px solid #dc3545;
}

.log-line .line-num {
    color: #6c757d;
    min-width: 40px;
    text-align: right;
    user-select: none;
}

.log-line .log-content {
    color: #d4d4d4;
    flex: 1;
    word-break: break-all;
}

.log-line.issue-line .log-content {
    color: #f8d7da;
}

/* Copy Button */
.copy-btn {
    background: #3d3d3d;
    border: none;
    color: #adb5bd;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.copy-btn:hover {
    background: #4d4d4d;
    color: white;
}

.copy-btn.copied {
    background: #28a745;
    color: white;
}

/* Issue Meta */
.issue-meta {
    display: flex;
    gap: 1.5rem;
    font-size: 0.8rem;
    color: #6c757d;
    padding-top: 1rem;
    border-top: 1px solid #eee;
    margin-top: 1rem;
}

.issue-meta span {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* File Header */
.file-header {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.health-score {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
}

.health-score.good { background: linear-gradient(135deg, #28a745, #20c997); }
.health-score.medium { background: linear-gradient(135deg, #ffc107, #fd7e14); }
.health-score.poor { background: linear-gradient(135deg, #dc3545, #e83e8c); }

/* Summary Stats */
.stats-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-box {
    flex: 1;
    background: white;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.stat-box .number {
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1;
}

.stat-box .label {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.stat-box.critical .number { color: #6f42c1; }
.stat-box.high .number { color: #dc3545; }
.stat-box.medium .number { color: #ffc107; }
.stat-box.low .number { color: #28a745; }

/* Filter Pills */
.filter-pills {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.filter-pill {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    border: 2px solid #dee2e6;
    background: white;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.filter-pill:hover, .filter-pill.active {
    border-color: #0d6efd;
    color: #0d6efd;
}

.filter-pill .count {
    background: #e9ecef;
    padding: 0.1rem 0.4rem;
    border-radius: 10px;
    font-size: 0.7rem;
    margin-left: 0.5rem;
}

.filter-pill.active .count {
    background: #0d6efd;
    color: white;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: #28a745;
}
</style>
{% endblock %}

{% block content %}
{% set score = health_score.score if health_score is mapping else health_score %}

<!-- File Header -->
<div class="file-header">
    <div class="row align-items-center">
        <div class="col-auto">
            <div class="health-score {% if score >= 80 %}good{% elif score >= 50 %}medium{% else %}poor{% endif %}">
                {{ score }}
            </div>
        </div>
        <div class="col">
            <h1 class="h4 mb-1">{{ log_file.original_filename }}</h1>
            <p class="text-muted mb-0">
                {{ log_file.upload_date.strftime('%B %d, %Y at %H:%M') if log_file.upload_date else 'Just uploaded' }}
                &bull; {{ (log_file.file_size / 1024)|round(1) }} KB
                &bull; {{ log_file.total_lines|default(0) }} lines
            </p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary me-2" onclick="copyFullReport()">
                <i class="bi bi-clipboard me-1"></i>Copy Report
            </button>
            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back
            </a>
        </div>
    </div>
</div>

<!-- Summary Stats -->
{% set critical_count = issues|selectattr('severity', 'equalto', 'CRITICAL')|list|length %}
{% set high_count = issues|selectattr('severity', 'equalto', 'HIGH')|list|length %}
{% set medium_count = issues|selectattr('severity', 'equalto', 'MEDIUM')|list|length %}
{% set low_count = issues|selectattr('severity', 'equalto', 'LOW')|list|length %}

<div class="stats-row">
    <div class="stat-box critical">
        <div class="number">{{ critical_count }}</div>
        <div class="label">Critical</div>
    </div>
    <div class="stat-box high">
        <div class="number">{{ high_count }}</div>
        <div class="label">High</div>
    </div>
    <div class="stat-box medium">
        <div class="number">{{ medium_count }}</div>
        <div class="label">Medium</div>
    </div>
    <div class="stat-box low">
        <div class="number">{{ low_count }}</div>
        <div class="label">Low</div>
    </div>
</div>

<!-- Filter Pills -->
<div class="filter-pills">
    <button class="filter-pill active" data-filter="all">
        All <span class="count">{{ issues|length }}</span>
    </button>
    <button class="filter-pill" data-filter="CRITICAL">
        Critical <span class="count">{{ critical_count }}</span>
    </button>
    <button class="filter-pill" data-filter="HIGH">
        High <span class="count">{{ high_count }}</span>
    </button>
    <button class="filter-pill" data-filter="MEDIUM">
        Medium <span class="count">{{ medium_count }}</span>
    </button>
    <button class="filter-pill" data-filter="LOW">
        Low <span class="count">{{ low_count }}</span>
    </button>
</div>

<!-- Issues List -->
{% if issues %}
<div id="issuesList">
    {% for issue in issues %}
    <div class="issue-card {{ issue.severity|lower }}" data-severity="{{ issue.severity }}">
        <div class="issue-header">
            <div>
                <span class="severity-badge {{ issue.severity|lower }}">{{ issue.severity }}</span>
                <span class="ms-2 text-muted small">{{ issue.category }}</span>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="copyIssueReport({{ issue.id }})">
                <i class="bi bi-clipboard me-1"></i>Copy for Dev
            </button>
        </div>

        <h5 class="issue-title">{{ issue.title }}</h5>
        <p class="issue-description">{{ issue.description }}</p>

        <!-- What This Means -->
        {% if issue.explanation %}
        <div class="explanation-section">
            <h6><i class="bi bi-lightbulb me-1"></i>What This Means</h6>
            <p>{{ issue.explanation }}</p>
        </div>
        {% endif %}

        <!-- Why It Matters -->
        {% if issue.why_it_matters %}
        <div class="impact-section">
            <h6><i class="bi bi-exclamation-triangle me-1"></i>Why It Matters</h6>
            <p>{{ issue.why_it_matters }}</p>
        </div>
        {% endif %}

        <!-- Suggested Actions -->
        {% if issue.suggested_actions %}
        <div class="mb-3">
            <h6 class="text-muted small text-uppercase mb-2">
                <i class="bi bi-check2-square me-1"></i>Suggested Actions
            </h6>
            <ul class="actions-list">
                {% for action in issue.suggested_actions[:4] %}
                <li>{{ action }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Log Evidence -->
        {% if issue.log_entries %}
        <div class="log-evidence">
            <div class="log-evidence-header">
                <h6><i class="bi bi-terminal me-1"></i>Log Lines ({{ issue.occurrence_count }} occurrences{% if issue.more_lines_count > 0 %}, showing first 30{% endif %})</h6>
                <button class="copy-btn" onclick="copyLogEvidence(this, {{ issue.id }})">
                    <i class="bi bi-clipboard me-1"></i>Copy
                </button>
            </div>
            <div class="log-evidence-content">
                {% for entry in issue.log_entries %}
                <div class="log-line {% if entry.is_issue_line %}issue-line{% endif %}">
                    <span class="line-num">{{ entry.line_number }}</span>
                    <span class="log-content">{{ entry.raw_content }}</span>
                </div>
                {% endfor %}
                {% if issue.more_lines_count > 0 %}
                <div class="log-line" style="background: #2d2d2d; justify-content: center;">
                    <span class="log-content" style="color: #6c757d; font-style: italic;">
                        ... and {{ issue.more_lines_count }} more occurrences in the log
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
        {% elif issue.context %}
        <div class="log-evidence">
            <div class="log-evidence-header">
                <h6><i class="bi bi-terminal me-1"></i>Log Evidence</h6>
                <button class="copy-btn" onclick="copyLogContext(this, `{{ issue.context|e }}`)">
                    <i class="bi bi-clipboard me-1"></i>Copy
                </button>
            </div>
            <div class="log-evidence-content">
                {% for line in issue.context.split('\n') %}
                <div class="log-line {% if 'ERROR' in line or 'CRITICAL' in line %}issue-line{% endif %}">
                    <span class="log-content">{{ line }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Issue Meta -->
        <div class="issue-meta">
            <span><i class="bi bi-clock me-1"></i>{{ issue.first_occurrence if issue.first_occurrence else 'Unknown' }}</span>
            <span><i class="bi bi-arrow-repeat me-1"></i>{{ issue.occurrence_count }} occurrence{% if issue.occurrence_count != 1 %}s{% endif %}</span>
            <span><i class="bi bi-percent me-1"></i>{{ (issue.confidence_score * 100)|round(0) }}% confidence</span>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <i class="bi bi-check-circle"></i>
    <h3>No Issues Found</h3>
    <p>This log file looks clean. No errors or issues were detected.</p>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// Issues data
const issuesData = {{ issues|tojson|safe }};
const logFileName = "{{ log_file.original_filename }}";
const healthScore = {{ health_score.score if health_score is mapping else health_score }};

// Filter functionality
document.querySelectorAll('.filter-pill').forEach(pill => {
    pill.addEventListener('click', function() {
        document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
        this.classList.add('active');

        const filter = this.dataset.filter;
        document.querySelectorAll('.issue-card').forEach(card => {
            if (filter === 'all' || card.dataset.severity === filter) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });
});

// Copy single issue report
function copyIssueReport(issueId) {
    const issue = issuesData.find(i => i.id === issueId);
    if (!issue) return;

    let report = `=== BUG REPORT ===
File: ${logFileName}
Generated: ${new Date().toISOString()}

ISSUE: ${issue.title}
SEVERITY: ${issue.severity}
CATEGORY: ${issue.category}

DESCRIPTION:
${issue.description}

`;

    if (issue.explanation) {
        report += `WHAT THIS MEANS:
${issue.explanation}

`;
    }

    if (issue.why_it_matters) {
        report += `WHY IT MATTERS:
${issue.why_it_matters}

`;
    }

    if (issue.suggested_actions && issue.suggested_actions.length) {
        report += `SUGGESTED ACTIONS:
${issue.suggested_actions.map(a => '- ' + a).join('\n')}

`;
    }

    report += `DETAILS:
- First Occurrence: ${issue.first_occurrence || 'Unknown'}
- Occurrences: ${issue.occurrence_count}
- Confidence: ${(issue.confidence_score * 100).toFixed(0)}%

LOG EVIDENCE:
${issue.context || 'See log entries below'}
`;

    if (issue.log_entries && issue.log_entries.length) {
        report += '\n' + issue.log_entries.map(e => `[Line ${e.line_number}] ${e.raw_content}`).join('\n');
    }

    report += `

---
Generated by Sentinel Logger`;

    navigator.clipboard.writeText(report).then(() => {
        showToast('Issue report copied to clipboard!');
    });
}

// Copy log evidence
function copyLogEvidence(btn, issueId) {
    const issue = issuesData.find(i => i.id === issueId);
    if (!issue || !issue.log_entries) return;

    const text = issue.log_entries.map(e => `[Line ${e.line_number}] ${e.raw_content}`).join('\n');

    navigator.clipboard.writeText(text).then(() => {
        btn.classList.add('copied');
        btn.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
        setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '<i class="bi bi-clipboard me-1"></i>Copy';
        }, 2000);
    });
}

// Copy log context
function copyLogContext(btn, context) {
    navigator.clipboard.writeText(context).then(() => {
        btn.classList.add('copied');
        btn.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
        setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '<i class="bi bi-clipboard me-1"></i>Copy';
        }, 2000);
    });
}

// Copy full report
function copyFullReport() {
    let report = `=== LOG ANALYSIS REPORT ===
File: ${logFileName}
Health Score: ${healthScore}/100
Generated: ${new Date().toISOString()}
Total Issues: ${issuesData.length}

SUMMARY:
- Critical: ${issuesData.filter(i => i.severity === 'CRITICAL').length}
- High: ${issuesData.filter(i => i.severity === 'HIGH').length}
- Medium: ${issuesData.filter(i => i.severity === 'MEDIUM').length}
- Low: ${issuesData.filter(i => i.severity === 'LOW').length}

=== ISSUES ===

`;

    issuesData.forEach((issue, index) => {
        report += `--- Issue #${index + 1}: ${issue.title} ---
Severity: ${issue.severity}
Category: ${issue.category}
Description: ${issue.description}
${issue.explanation ? `Explanation: ${issue.explanation}` : ''}
${issue.why_it_matters ? `Impact: ${issue.why_it_matters}` : ''}
First Seen: ${issue.first_occurrence || 'Unknown'}
Occurrences: ${issue.occurrence_count}

Log Evidence:
${issue.context || 'N/A'}
${issue.log_entries ? issue.log_entries.map(e => `[Line ${e.line_number}] ${e.raw_content}`).join('\n') : ''}

`;
    });

    report += `---
Generated by Sentinel Logger`;

    navigator.clipboard.writeText(report).then(() => {
        showToast('Full report copied to clipboard!');
    });
}

// Toast notification
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 end-0 p-3';
    toast.style.zIndex = '1050';
    toast.innerHTML = `
        <div class="toast show align-items-center text-white bg-success border-0">
            <div class="d-flex">
                <div class="toast-body"><i class="bi bi-check-circle me-2"></i>${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.position-fixed').remove()"></button>
            </div>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
